# 权限控制

## User Controller

- 文件名：api/controller/User.php
- 第2105行插入以下代码

```php
    /**
     * 判断用户是否在白名单
     * @return mixed
     */
    public function isWhitelist()
    {
        $data = $this->param;
        if (empty($data['action'])) {
            return api_error(['code' => '0010', 'msg' => 'Action参数不能为空']);
        }

        if (!preg_match('/^[a-z0-9A-Z\/]+$/', $data['action'])) {
            return api_error(['code' => '0010', 'msg' => 'Action参数不合法']);
        }

        $action = $data['action'];
        $userInfo = get_user_by_token($data);
        $uid = intval($userInfo['uid']);

        $isWhitelist = false;
        $list = $this->logicUserWhitelist->isWhitelist($uid, $action);

        if (!empty($list) || is_array($list)) {
            $isWhitelist = true;
        }

        return $this->apiReturn(
            ['is_whitelist' => $isWhitelist, 'action' => $action]
        );
    }
```

## User Whitelist Logic

- 新建文件 api/logic/UserWhitelist.php

```php
<?php

namespace app\api\logic;

use think\Db;

class UserWhitelist extends ApiBase
{
    public function isWhitelist($uid, $action)
    {
        $where = [
            'uid' => $uid, 'action' => $action,
        ];

        $data = Db::name('UserWhitelist')->where($where)->find();

        // 不在白名单
        if (empty($data)) {
            return false;
        }

        $updateTime = $data['update_time'];
        $expireTime = $updateTime + (3 * 24 * 60 * 60);
        $currentTime = time();

        // 过期了
        if ($currentTime > $expireTime) {
            return false;
        }

        return $data;
    }

}
```

## UserActionLog

- 新建文件 api/logic/UserActionLog.php

```php
<?php

namespace app\api\logic;

use think\Db;

class UserActionLog extends ApiBase
{
    public function createLog($uid, $action)
    {
        $data = [
            'uid' => $uid,
            'action' => $action,
            'ip' => $this->getClientIp(),
            'create_time' => time(),
        ];

        Db::name("UserActionLog")->insert($data);
    }

    public function getClientIp()
    {
        if ($_SERVER["REMOTE_ADDR"] && strcasecmp($_SERVER["REMOTE_ADDR"], "unknown")) {
            $ip = $_SERVER["REMOTE_ADDR"];
        } else {
            if (isset ($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'],
                    "unknown")
            ) {
                $ip = $_SERVER['REMOTE_ADDR'];
            } else {
                $ip = "unknown";
            }
        }
        return $ip;
    }
}

```

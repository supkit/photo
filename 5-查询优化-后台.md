
## 一、执行数据迁移

> 打开 phpMyAdmin -> 选择「xmpzkj_cn」这个数据库，执行以下SQL：

```SQL
UPDATE `yql_photo` SET upload_time = STR_TO_DATE(SUBSTRING_INDEX(`key`, '/', 1), '%Y%m%d');
```

## 二、覆盖Controller文件

> 文件名 /www/wwwroot/dev/app/api/controller/Photo.php（直接覆盖即可）

```php
<?php

namespace app\api\controller;

class Photo extends ApiBase
{
    /**
     * 图片资源URL
     * @var string
     */
    private $cosUrl = 'http://qny.xmpzkj.cn/';

    /**
     * 图片搜索
     * @return mixed
     */
    public function search()
    {
        $data = $this->param;
        $userInfo = get_user_by_token($data);
        $uid = $userInfo['uid'];
        $action = 'photoSearch';
        $isWhitelist = $this->logicUserWhitelist->isWhitelist($uid, $action);
        if (empty($isWhitelist)) {
            return api_error(['code' => '0010', 'msg' => '当前用户无权限操作']);
        }

        $transferor = empty($data['transferor']) ? '' : trim($data['transferor']);
        $payee = empty($data['payee']) ? '' : trim($data['payee']);

        $amountMin = empty($data['amount_min']) ? '' : trim($data['amount_min']);
        $amountMax = empty($data['amount_max']) ? '' : trim($data['amount_max']);
        $startTime = empty($data['start_time']) ? '' : trim($data['start_time']);
        $endTime = empty($data['end_time']) ? '' : trim($data['end_time']);
        $content = empty($data['content']) ? '' : trim($data['content']);
        $page = empty($data['page']) ? 1 : trim($data['page']);
        $page = intval($page);
        $pageSize = empty($data['pagesize']) ? 20 : trim($data['pagesize']);
        $pageSize = intval($pageSize);
        $startUploadTime = empty($data['start_upload_time']) ? '' : trim($data['start_upload_time']);
        $endUploadTime = empty($data['end_upload_time']) ? '' : trim($data['end_upload_time']);

        if (
            empty($transferor) && empty($payee) && empty($amountMin) &&
            empty($amountMax) && empty($startTime) && empty($endTime) && empty($content) &&
            empty($startUploadTime) && empty($endUploadTime)
        ) {
            return api_error(['code' => '0010', 'msg' => '至少包含一个搜索参数']);
        }

        if (!empty($startTime) && empty($endTime)) {
            return api_error(['code' => '0010', 'msg' => '转账时间必须是一个范围']);
        }

        if (!empty($endTime) && empty($startTime)) {
            return api_error(['code' => '0010', 'msg' => '转账时间必须是一个范围']);
        }

        if (!empty($startUploadTime) && empty($endUploadTime)) {
            return api_error(['code' => '0010', 'msg' => '图片上传时间必须是一个范围']);
        }

        if (!empty($endUploadTime) && empty($startUploadTime)) {
            return api_error(['code' => '0010', 'msg' => '图片上传时间必须是一个范围']);
        }

        if (!empty($content)) {
            $content = explode(';', $content);
            if (!is_array($content)) {
                return api_error(['code' => '0010', 'msg' => '图片内容字段必须是一个数组']);
            }
        }

        $result = $this->logicPhoto->searchPhotos(
            $page, $pageSize, $transferor, $payee, $amountMin, $amountMax,
            $startTime, $endTime, $startUploadTime, $endUploadTime, $content
        );

        if (!is_array($result) || empty($result)) {
            $result = ['records' => [], 'total' => 0];
        }

        $records = $result['records'];
        $total = $result['total'];

        $host = 'http://'.$_SERVER['HTTP_HOST'];
        foreach ($records as $key => $value) {
            $records[$key]['url'] = $host.'/api.php/photo/download?key='.$value['key'];
            $records[$key]['content'] = '';
            $records[$key]['transferor'] = '';
            $records[$key]['payee'] = '';
        }

        $this->logicUserActionLog->createLog($uid, $action);
        return $this->apiReturn([
            'records' => $records,
            'total' => $total,
        ]);
    }

    /**
     * 图片下载
     * @return void
     */
    public function download()
    {
        $data = $this->param;
        $userInfo = get_user_by_token($data);
        $uid = $userInfo['uid'];
        $action = 'photoSearch';
        $isWhitelist = $this->logicUserWhitelist->isWhitelist($uid, $action);
        if (empty($isWhitelist)) {
            return api_error(['code' => '0010', 'msg' => '当前用户无权限操作']);
        }

        if (empty($data['key'])) {
            return api_error(['code' => '0010', 'msg' => '文件Key不能为空']);
        }
        $key = $data['key'];
        if (!preg_match('/^[a-z0-9A-Z\/]+\.[a-zA-Z]+$/', $key)) {
            return api_error(['code' => '0010', 'msg' => '文件Key不合法']);
        }

        $data = $this->logicPhoto->findFileWthKey($key);
        if (empty($data)) {
            return api_error(['code' => '0010', 'msg' => '文件不存在']);
        }

        $url = $this->cosUrl.$key;
        $content = $this->getContent($url);

        if (empty($content)) {
            return api_error(['code' => '0010', 'msg' => '文件内容下载异常']);
        }

        if (!empty($this->param['download'])) {
            $this->logicUserActionLog->createLog($uid, $action.'Download');
        }

        // 给图片加文字水印
        $tempImage = tempnam(sys_get_temp_dir(), 'temp_image');
        file_put_contents($tempImage, $content);
        $imageInfo = getimagesize($tempImage);

        if (!is_array($imageInfo)) {
            return api_error(['code' => '0010', 'msg' => '图片信息异常']);
        }

        if ($imageInfo['mime'] == 'image/png') {
            $image = imagecreatefrompng($tempImage);
        } else if ($imageInfo['mime'] == 'image/jpg') {
            $image = imagecreatefromjpeg($tempImage);
        } else if ($imageInfo['mime'] == 'image/jpeg') {
            $image = imagecreatefromjpeg($tempImage);
        }

        $width = $imageInfo[0];
        $height = $imageInfo[1];

        $fontSize = 14;
        $text = 'UID:' . $uid . ' '.date('Y-m-d', time());
        $color = imagecolorallocatealpha($image, 150, 150, 150, 20);

        $coordinates = $this->makeCoordinates($width,  $height);
        foreach ($coordinates as $val) {
            imagettftext($image, $fontSize, 30, $val['x'], $val['y'], $color, './font/simsun.ttf', $text);
        }

        // 清空输出缓冲区
        ob_clean();
        flush();

        if ($imageInfo['mime'] == 'image/png') {
            header('Content-Type: image/png');
            imagepng($image);
        } else if ($imageInfo['mime'] == 'image/jpg' || $imageInfo['mime'] == 'image/jpeg') {
            header('Content-Type: image/jpeg');
            imagejpeg($image);
        }

        // 释放内存
        imagedestroy($image);

        // 删除临时文件
        unlink($tempImage); exit;
    }

    private function getContent($url)
    {
        // 初始化 cURL 会话
        $ch = curl_init();

        // 设置 cURL 选项
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true); // 允许重定向
        $content = curl_exec($ch);
        if (curl_errno($ch)) {
            return '';
        }

        return $content;
    }

    /**
     * 生成水印坐标值
     * @param $width
     * @param $height
     * @return array
     */
    private function makeCoordinates($width, $height)
    {
        if (empty($width) || empty($height)) {
            return [];
        }

        $width = intval($width);
        $height = intval($height);

        $x = 10;
        $y = 10;
        $xArr = [];
        $yArr = [];

        $xSpace = 260;
        $ySpace = 80;

        while (true) {
            array_push($xArr, $x);
            $x = $x + $xSpace;
            if ($x > $width) {
                break;
            }
        }

        while (true) {
            array_push($yArr, $y);
            $y = $y + $ySpace;
            if ($y > $height) {
                break;
            }
        }

        $coordinates = [];
        foreach ($xArr as $x) {
            foreach ($yArr as $y) {
                $coordinates[] = ['x' => $x, 'y' => $y];
            }
        }

        return $coordinates;
    }
}
```

## 三、覆盖Logic文件

> 文件名 /www/wwwroot/dev/app/api/logic/Photo.php （直接覆盖即可）

```php
<?php

namespace app\api\logic;

use think\Db;

class Photo extends ApiBase
{
    public function searchPhotos(
        $page, $pageSize, $transferor, $payee, $amountMin, $amountMax,
        $startTime, $endTime, $startUploadTime, $endUploadTime, $content
    )
    {
        $db = Db::name('Photo');
        $totalQuery = Db::name('Photo');
        $where = [];

        if (!empty($transferor)) {
            $where['transferor'] = ['like', '%'.$transferor.'%'];
        }

        if (!empty($payee)) {
            $where['payee'] = ['like', '%'.$payee.'%'];
        }

        if (!empty($amountMin)) {
            $where['amount'] = ['>=', $amountMin];
        }

        if (!empty($amountMax)) {
            $where['amount'] = ['<=', $amountMax];
        }

        if (!empty($content) && is_array($content)) {
            $db->where(function($query) use ($content) {
                foreach ($content as $v) {
                    $query->where('content', 'like', '%' . $v . '%');
                }
            });
        }

        $field = ['id', 'key', 'transferor', 'payee', 'amount', 'date_time', 'upload_time', 'content'];
        if (!empty($startTime)) {
            $db->where('date_time', '>=', $startTime);
            $totalQuery->where('date_time', '>=', $startTime);
        }

        if (!empty($endTime)) {
            $db->where('date_time', '<=', $endTime);
            $totalQuery->where('date_time', '<=', $endTime);
        }

        if (!empty($startUploadTime)) {
            $db->where('upload_time', '>=', $startUploadTime);
            $totalQuery->where('upload_time', '>=', $startUploadTime);
        }

        if (!empty($endUploadTime)) {
            $db->where('upload_time', '<=', $endUploadTime);
            $totalQuery->where('upload_time', '<=', $endUploadTime);
        }

        $offset = ($page - 1) * $pageSize;
        $db->where($where);

        $records = $db->field($field)->limit($offset, $pageSize)->select();

        // 查询总数
        if (!empty($content) && is_array($content)) {
            $totalQuery->where(function($query) use ($content) {
                foreach ($content as $v) {
                    $query->where('content', 'like', '%' . $v . '%');
                }
            });
        }
        $total = $totalQuery->where($where)->count();

        return [
            'records' => $records,
            'total' => $total,
        ];
    }

    public function findFileWthKey($key)
    {
        $where['key'] = $key;
        $data = Db::name("Photo")->where($where)->find();
        return $data;
    }
}
```

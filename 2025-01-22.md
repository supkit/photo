
## 一、执行数据迁移

> 打开 phpMyAdmin -> 选择「xmpzkj_cn」这个数据库，执行以下SQL：

```SQL
UPDATE `yql_photo` SET upload_time = STR_TO_DATE(SUBSTRING_INDEX(`key`, '/', 1), '%Y%m%d');
```

## 二、覆盖Controller文件

> 文件名 /www/wwwroot/dev/app/api/controller/Photo.php（直接覆盖即可）

```php
<?php

namespace app\api\controller;

class Photo extends ApiBase
{
    /**
     * 图片资源URL
     * @var string
     */
    private $cosUrl = 'http://qny.xmpzkj.cn/';

    /**
     * 图片搜索
     * @return mixed
     */
    public function search()
    {
        $data = $this->param;
        $userInfo = get_user_by_token($data);
        $uid = $userInfo['uid'];
        $action = 'photoSearch';
        $isWhitelist = $this->logicUserWhitelist->isWhitelist($uid, $action);
        if (empty($isWhitelist)) {
            return api_error(['code' => '0010', 'msg' => '当前用户无权限操作']);
        }

        $transferor = empty($data['transferor']) ? '' : trim($data['transferor']);
        $payee = empty($data['payee']) ? '' : trim($data['payee']);

        $amountMin = empty($data['amount_min']) ? '' : trim($data['amount_min']);
        $amountMax = empty($data['amount_max']) ? '' : trim($data['amount_max']);
        $startTime = empty($data['start_time']) ? '' : trim($data['start_time']);
        $endTime = empty($data['end_time']) ? '' : trim($data['end_time']);
        $content = empty($data['content']) ? '' : trim($data['content']);
        $page = empty($data['page']) ? 1 : trim($data['page']);
        $page = intval($page);
        $pageSize = empty($data['pagesize']) ? 20 : trim($data['pagesize']);
        $pageSize = intval($pageSize);
        $startUploadTime = empty($data['start_upload_time']) ? '' : trim($data['start_upload_time']);
        $endUploadTime = empty($data['end_upload_time']) ? '' : trim($data['end_upload_time']);

        if (
            empty($transferor) && empty($payee) && empty($amountMin) &&
            empty($amountMax) && empty($startTime) && empty($endTime) && empty($content) &&
            empty($startUploadTime) && empty($endUploadTime)
        ) {
            return api_error(['code' => '0010', 'msg' => '至少包含一个搜索参数']);
        }

        if (!empty($startTime) && empty($endTime)) {
            return api_error(['code' => '0010', 'msg' => '转账时间必须是一个范围']);
        }

        if (!empty($endTime) && empty($startTime)) {
            return api_error(['code' => '0010', 'msg' => '转账时间必须是一个范围']);
        }

        if (!empty($startUploadTime) && empty($endUploadTime)) {
            return api_error(['code' => '0010', 'msg' => '图片上传时间必须是一个范围']);
        }

        if (!empty($endUploadTime) && empty($startUploadTime)) {
            return api_error(['code' => '0010', 'msg' => '图片上传时间必须是一个范围']);
        }

        if (!empty($content)) {
            $content = explode(';', $content);
            if (!is_array($content)) {
                return api_error(['code' => '0010', 'msg' => '图片内容字段必须是一个数组']);
            }
        }

        $result = $this->logicPhoto->searchPhotos(
            $page, $pageSize, $transferor, $payee, $amountMin, $amountMax,
            $startTime, $endTime, $startUploadTime, $endUploadTime, $content
        );

        if (!is_array($result) || empty($result)) {
            $result = ['records' => [], 'total' => 0];
        }

        $records = $result['records'];
        $total = $result['total'];

        $host = 'http://'.$_SERVER['HTTP_HOST'];
        foreach ($records as $key => $value) {
            $records[$key]['url'] = $host.'/api.php/photo/download?key='.$value['key'];
            $records[$key]['content'] = '';
            $records[$key]['transferor'] = '';
            $records[$key]['payee'] = '';
        }

        $this->logicUserActionLog->createLog($uid, $action);
        return $this->apiReturn([
            'records' => $records,
            'total' => $total,
        ]);
    }

    /**
     * 图片下载
     * @return void
     */
    public function download()
    {
        $data = $this->param;
        $userInfo = get_user_by_token($data);
        $uid = $userInfo['uid'];
        $action = 'photoSearch';
        $isWhitelist = $this->logicUserWhitelist->isWhitelist($uid, $action);
        if (empty($isWhitelist)) {
            return api_error(['code' => '0010', 'msg' => '当前用户无权限操作']);
        }

        if (empty($data['key'])) {
            return api_error(['code' => '0010', 'msg' => '文件Key不能为空']);
        }
        $key = $data['key'];
        if (!preg_match('/^[a-z0-9A-Z\/]+\.[a-zA-Z]+$/', $key)) {
            return api_error(['code' => '0010', 'msg' => '文件Key不合法']);
        }

        $data = $this->logicPhoto->findFileWthKey($key);
        if (empty($data)) {
            return api_error(['code' => '0010', 'msg' => '文件不存在']);
        }

        $url = $this->cosUrl.$key;
        $content = $this->getContent($url);

        if (empty($content)) {
            return api_error(['code' => '0010', 'msg' => '文件内容下载异常']);
        }

        if (!empty($this->param['download'])) {
            $this->logicUserActionLog->createLog($uid, $action.'Download');
        }

        // 给图片加文字水印
        $tempImage = tempnam(sys_get_temp_dir(), 'temp_image');
        file_put_contents($tempImage, $content);
        $imageInfo = getimagesize($tempImage);

        if (!is_array($imageInfo)) {
            return api_error(['code' => '0010', 'msg' => '图片信息异常']);
        }

        if ($imageInfo['mime'] == 'image/png') {
            $image = imagecreatefrompng($tempImage);
        } else if ($imageInfo['mime'] == 'image/jpg') {
            $image = imagecreatefromjpeg($tempImage);
        } else if ($imageInfo['mime'] == 'image/jpeg') {
            $image = imagecreatefromjpeg($tempImage);
        }

        $width = $imageInfo[0];
        $height = $imageInfo[1];

        $fontSize = 14;
        $text = 'UID:' . $uid . ' '.date('Y-m-d', time());
        $color = imagecolorallocatealpha($image, 150, 150, 150, 20);

        $coordinates = $this->makeCoordinates($width,  $height);
        foreach ($coordinates as $val) {
            imagettftext($image, $fontSize, 30, $val['x'], $val['y'], $color, './font/simsun.ttf', $text);
        }

        // 清空输出缓冲区
        ob_clean();
        flush();

        if ($imageInfo['mime'] == 'image/png') {
            header('Content-Type: image/png');
            imagepng($image);
        } else if ($imageInfo['mime'] == 'image/jpg' || $imageInfo['mime'] == 'image/jpeg') {
            header('Content-Type: image/jpeg');
            imagejpeg($image);
        }

        // 释放内存
        imagedestroy($image);

        // 删除临时文件
        unlink($tempImage); exit;
    }

    private function getContent($url)
    {
        // 初始化 cURL 会话
        $ch = curl_init();

        // 设置 cURL 选项
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true); // 允许重定向
        $content = curl_exec($ch);
        if (curl_errno($ch)) {
            return '';
        }

        return $content;
    }

    /**
     * 生成水印坐标值
     * @param $width
     * @param $height
     * @return array
     */
    private function makeCoordinates($width, $height)
    {
        if (empty($width) || empty($height)) {
            return [];
        }

        $width = intval($width);
        $height = intval($height);

        $x = 10;
        $y = 10;
        $xArr = [];
        $yArr = [];

        $xSpace = 260;
        $ySpace = 80;

        while (true) {
            array_push($xArr, $x);
            $x = $x + $xSpace;
            if ($x > $width) {
                break;
            }
        }

        while (true) {
            array_push($yArr, $y);
            $y = $y + $ySpace;
            if ($y > $height) {
                break;
            }
        }

        $coordinates = [];
        foreach ($xArr as $x) {
            foreach ($yArr as $y) {
                $coordinates[] = ['x' => $x, 'y' => $y];
            }
        }

        return $coordinates;
    }
}
```

## 三、覆盖Logic文件

> 文件名 /www/wwwroot/dev/app/api/logic/Photo.php （直接覆盖即可）

```php
<?php

namespace app\api\logic;

use think\Db;

class Photo extends ApiBase
{
    public function searchPhotos(
        $page, $pageSize, $transferor, $payee, $amountMin, $amountMax,
        $startTime, $endTime, $startUploadTime, $endUploadTime, $content
    )
    {
        $db = Db::name('Photo');
        $totalQuery = Db::name('Photo');
        $where = [];

        if (!empty($transferor)) {
            $where['transferor'] = ['like', '%'.$transferor.'%'];
        }

        if (!empty($payee)) {
            $where['payee'] = ['like', '%'.$payee.'%'];
        }

        if (!empty($amountMin)) {
            $where['amount'] = ['>=', $amountMin];
        }

        if (!empty($amountMax)) {
            $where['amount'] = ['<=', $amountMax];
        }

        if (!empty($content) && is_array($content)) {
            $db->where(function($query) use ($content) {
                foreach ($content as $v) {
                    $query->where('content', 'like', '%' . $v . '%');
                }
            });
        }

        $field = ['id', 'key', 'transferor', 'payee', 'amount', 'date_time', 'upload_time', 'content'];
        if (!empty($startTime)) {
            $db->where('date_time', '>=', $startTime);
            $totalQuery->where('date_time', '>=', $startTime);
        }

        if (!empty($endTime)) {
            $db->where('date_time', '<=', $endTime);
            $totalQuery->where('date_time', '<=', $endTime);
        }

        if (!empty($startUploadTime)) {
            $db->where('upload_time', '>=', $startUploadTime);
            $totalQuery->where('upload_time', '>=', $startUploadTime);
        }

        if (!empty($endUploadTime)) {
            $db->where('upload_time', '<=', $endUploadTime);
            $totalQuery->where('upload_time', '<=', $endUploadTime);
        }

        $offset = ($page - 1) * $pageSize;
        $db->where($where);

        $records = $db->field($field)->limit($offset, $pageSize)->select();

        // 查询总数
        if (!empty($content) && is_array($content)) {
            $totalQuery->where(function($query) use ($content) {
                foreach ($content as $v) {
                    $query->where('content', 'like', '%' . $v . '%');
                }
            });
        }
        $total = $totalQuery->where($where)->count();

        return [
            'records' => $records,
            'total' => $total,
        ];
    }

    public function findFileWthKey($key)
    {
        $where['key'] = $key;
        $data = Db::name("Photo")->where($where)->find();
        return $data;
    }
}
```

# 图片查询

1. 显示总查询数量和翻页的功能
2. 模糊查询要能支持多条件查询，以逗号或分号分隔
3. 增加一个筛选条件，图片上传时间


## 1. 前端代码更新

`在上一版的基础上`

1. 修改 `platforms/h5/photoSearch/component/SearchBox.vue` 文件，将其内容更新为：

```
<template>
	<view class="wx-search-box">
		<div style="display: flex; flex-direction: column; gap: 8px;">
			<view class="row">
				<div class="row-item">
					<view class="label">转账/收款方:</view>
					<view class="content"><el-input v-model="username" placeholder="转账/收款方姓名"></el-input></view>
				</div>
				<div class="row-item">
					<view class="label">转账金额范围:</view>
					<view class="content">
						<el-input v-model="amount_min" placeholder="转账金额最小值"></el-input>
						～
						<el-input v-model="amount_max" placeholder="转账金额最大值"></el-input>
					</view>
				</div>
			</view>
			<view class="row">
				<div class="row-item">
					<view class="label">转账时间范围:</view>
					<view class="content">
						<el-date-picker v-model="date_min" style='width: 100%;' type="date" :picker-options="pickerOptions"
							value-format="yyyy-MM-dd" placeholder="选择日期">
						</el-date-picker>
						～
						<el-date-picker v-model="date_max" style='width: 100%;' type="date" :picker-options="pickerOptions"
							value-format="yyyy-MM-dd" placeholder="选择日期">
						</el-date-picker>
					</view>
				</div>
				<div class="row-item">
					<view class="label">图片上传时间:</view>
					<view class="content">
						<el-date-picker v-model="upload_date_min" style='width: 100%;' type="date" :picker-options="pickerOptions"
							value-format="yyyy-MM-dd" placeholder="选择日期">
						</el-date-picker>
						～
						<el-date-picker v-model="upload_date_max" style='width: 100%;' type="date" :picker-options="pickerOptions"
							value-format="yyyy-MM-dd" placeholder="选择日期">
						</el-date-picker>
					</view>
				</div>
			</view>
			<view class="row">
				<div class="row-item">
					<view class="label">文本内容:</view>
					<view class="content"><el-input v-model="keyword" placeholder="请输入文本内容进行查询，多个查询内容之间以逗号或分号分隔"></el-input>
					</view>
				</div>
				<div class="row-item">
					<view class="label"></view>
					<view class="content operation">
						<el-button style="width: 100px;" round @click="onClear">清空</el-button>
						<el-button type="primary" style="width: 100px;" round @click="Search">搜索</el-button>
					</view>
				</div>
			</view>
		</div>
	</view>
</template>

<script>
export default {
	name: 'search',

	data() {
		return {
			username: '',
			amount_min: '',
			amount_max: '',
			date_min: '',
			date_max: '',
			upload_date_min: '',
			upload_date_max: '',
			keyword: '',
			pickerOptions: {
				disabledDate: (time) => {
					return time.getTime() > Date.now();
				},
			},
		}
	},

	methods: {
		onClear(data) {
			this.username = '';
			this.amount_min = '';
			this.amount_max = '';
			this.date_min = '';
			this.date_max = '';
			this.upload_date_min = '';
			this.upload_date_max = '';
			this.keyword = '';
			this.$emit('clear');
		},
		Search() {
			// 触发自定义事件，将搜索内容传递给父组件
			this.$emit('search', {
				username: this.username,
				amount_min: this.amount_min,
				amount_max: this.amount_max,
				date_min: this.date_min,
				date_max: this.date_max,
				upload_date_min: this.upload_date_min,
				upload_date_max: this.upload_date_max,
				keyword: this.keyword,
			});
		}
	}
}
</script>

<style lang="scss" scoped>
.wx-search-box {
	display: flex;
	flex-direction: column;
	gap: 8px;
	padding: 10px;
	border-radius: 15px;
	background-color: #FFFFFF;

	.row {
		display: flex;
		gap: 16px;
		align-items: center;

		.row-item {
			display: flex;
			flex: 1;
			align-items: center;
			gap: 8px;

			.label {
				width: 100px;
				text-align: right;
			}

			.content {
				display: flex;
				flex-grow: 1;
				align-items: center;
			}
		}
	}
}
</style>

```


2. 修改 `platforms/h5/photoSearch/component/SearchResult.vue` 文件，将其内容更新为：

```
<template>
	<div class="photo-search-result-container">
		<table v-show="items.length > 0" class="photo-search-result-table">
			<thead>
				<tr>
					<th>序号</th>
					<!-- <th>转账/收款方</th> -->
					<th>金额</th>
					<th>转账时间</th>
					<th>图片上传时间</th>
					<!-- <th>图片全部内容</th> -->
					<th>图片链接</th>
				</tr>
			</thead>
			<tbody>
				<tr v-for="(item, index) in items" :key="item.id">
					<td>{{ index + 1 }}</td>
					<!-- <td>{{ item.transferor }}/{{ item.payee }}</td> -->
					<td>{{ item.amount }}</td>
					<td>{{ item.date_time }}</td>
					<td>{{ item.upload_time }}</td>
					<!-- <td>{{ item.content }}</td> -->
					<td>
						<a :href="item.imageUrl + '&download=true'" target="_blank">
							<image class="image" :src="item.imageUrl" />
						</a>
					</td>
				</tr>
			</tbody>
		</table>
	</div>
</template>

<script>
export default {
	props: {
		items: {
			type: Array,
			default: () => []
		}
	}
};
</script>

<style lang="scss" scoped>
.photo-search-result-container {
	.photo-search-result-table {
		width: 100%;
		border-collapse: collapse;
		/* 合并边框 */
		margin: 20px 0;
		/* 上下外边距 */
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		/* 阴影效果 */

		th,
		td {
			padding: 12px;
			/* 内边距 */
			text-align: left;
			/* 左对齐 */
			border-bottom: 1px solid #ddd;
			/* 下边框 */
			max-width: 200px;
		}

		th {
			background-color: #4AA0E9;
			/* 表头背景色 */
			color: white;
			/* 表头文字颜色 */
		}

		tr:hover {
			background-color: #f5f5f5;
			/* 鼠标悬停时的背景色 */
		}

		tr:nth-child(even) {
			background-color: #f9f9f9;
			/* 偶数行背景色 */
		}

		tr:nth-child(odd) {
			background-color: #ffffff;
			/* 奇数行背景色 */
		}

		.image {
			width: 100px;
			height: 80px;
		}
	}

}
</style>
```


3. 修改 `platforms/h5/photoSearch/photoSearch.vue` 文件，将其内容更新为：

```
<template>
	<view style="width: 100%; height: 100%;">
		<view style="min-height: 1200rpx;">
			<div style="padding: 20px 32px;">
				<div class="photo-search-risk-tips">
					本查询只限图片数据丢失的用户使用，用户仅限查询和下载自己账号的图片，不允许下载其他用户图片。<br />用户使用过程系统会跟踪记录查询下载过程并加密下载图片，用户因下载图片流失造成侵权行为的，下载用户负全部责任，本公司不承担任何责任。
				</div>
				<div v-if="has_auth === true">
					<SearchBox @search="handleSearch" @clear="handleClear" />
					<div v-if="tips_msg" class="photo-search-tips">
						{{ tips_msg }}
					</div>
					<div v-else>
						<div v-if="search_result.length <= 0" class="photo-search-tips">
							没有查询到数据
						</div>
						<div v-else>
							<SearchResult :user_token="userToken" :items="search_result" />
							<div class="pager-container" v-if="search_result.length">
								<el-pagination @size-change="handleSizeChange" @current-change="handleCurrentChange"
									:current-page="page" :page-sizes="[10, 20, 30, 50]" :page-size="pagesize"
									layout="total, sizes, prev, pager, next, jumper" :total="pagecount">
								</el-pagination>
							</div>
						</div>
					</div>
				</div>
				<div v-else-if="has_auth === false" class="photo-search-tips">
					当前用户无权限使用该功能
				</div>
			</div>
		</view>
	</view>
</template>

<script>
import SearchBox from './component/SearchBox';
import SearchResult from './component/SearchResult';
import api from '@/components/vmeitime-http/index.js';

export default {
	components: {
		SearchBox,
		SearchResult
	},
	props: {
		mys: String
	},
	data() {
		return {
			userToken: '',
			userInfo: null,
			has_auth: undefined,
			filters: null, // 搜索条件
			page: 1,
			pagesize: 10,
			pagecount: 0,
			search_result: [], // 搜索结果
			tips_msg: '', // 错误提示信息
		}
	},

	onLoad() {
		var user_token = uni.getStorageSync('user_token')
		if (!user_token) {
			uni.reLaunch({
				url: '/platforms/h5/login/login'
			})
		}
		this.userToken = user_token;

		// 获取用户信息
		this.getUserInfo(user_token, userInfo => {
			// 获取用户信息成功后，才检查是否具有图片搜索权限，后续使用用户信息加水印
			this.checkPhotoSearchAuth(user_token);
			// 添加水印
			this.createWatermark(userInfo);
		});
	},

	beforeDestroy() {
		this.clearWatermarks();
	},

	methods: {
		handleSizeChange(val) {
			// console.log(`每页 ${val} 条`);
			this.pagesize = val;
			this.page = 1;
			this.fetchDataList(this.filters, { page: 1, pagesize: val })
		},

		handleCurrentChange(val) {
			// console.log(`当前页: ${val}`);
			this.page = val;
			this.fetchDataList(this.filters, { page: val, pagesize: this.pagesize })
		},

		async getUserInfo(user_token, callback) {
			try {
				const res = await api.userInfo({
					user_token: user_token,
				});
				const userInfo = res?.data?.data?.user_info;
				this.userInfo = userInfo;
				callback?.(userInfo);
			} catch (err) {
				// ignore
			}
		},

		getWindowContentSize() {
			const width = Math.max(
				document.body.scrollWidth,
				document.documentElement.scrollWidth,
				document.body.offsetWidth,
				document.documentElement.offsetWidth
			);

			const height = Math.max(
				document.body.scrollHeight,
				document.documentElement.scrollHeight,
				document.body.offsetHeight,
				document.documentElement.offsetHeight
			);

			return {
				width,
				height,
			}
		},

		clearWatermarks() {
			const elements = document.querySelectorAll('.watermark');
			elements.forEach(element => {
				element.remove();
			});
		},

		createWatermark(userInfo) {
			// 创建前先移除
			this.clearWatermarks();

			const { width, height } = this.getWindowContentSize();

			let watermarkText = this.userToken;
			const userId = userInfo?.uid;
			const userName = userInfo?.name;
			const phoneNumber = userInfo?.phone;
			if (userName || userId || phoneNumber) {
				watermarkText = `${userId || userName}-${phoneNumber}`;
			}

			const url = this.generateWatermark(`当前用户:${watermarkText}`);
			const element = document.createElement('div');
			element.className = 'watermark';
			element.style.position = 'absolute';
			element.style.left = '0px';
			element.style.top = '0px';
			element.style.width = `${width}px`;
			element.style.height = `${height}px`;
			element.style.backgroundImage = `url(${url})`;
			// element.style.backgroundSize = 'cover';
			element.style.backgroundRepeat = 'repeat';
			element.style.pointerEvents = 'none';

			document.body.appendChild(element);
		},

		generateWatermark(text) {
			const canvas = document.createElement('canvas');
			const ctx = canvas.getContext('2d');

			const H_PADDING = 20;

			// 设置字体样式
			const fontSize = 40;
			ctx.fontSize = `${fontSize}px`;
			// ctx.fillStyle = 'rgba(0, 0, 0, 0.15)'; // 设置水印颜色和透明度
			ctx.textAlign = 'center';
			ctx.textBaseline = 'middle';

			const textWidth = ctx.measureText(text).width;
			const textHeight = fontSize; // 字体大小

			// 设置 Canvas 尺寸
			canvas.width = textWidth + 2 * H_PADDING; // 文本左右各留H_PADDING的边距
			canvas.height = textHeight;

			ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; // 半透明黑色
			// 绘制水印文本
			ctx.fillText(text, H_PADDING, textHeight / 2);
			// ctx.fillText('信息请勿外传', H_PADDING, 30);

			// // 移动原点到 Canvas 中心
			// ctx.translate(canvas.width / 2, canvas.height / 2);
			// // 旋转 30 度（转换为弧度）
			// ctx.rotate(30 * Math.PI / 180);
			// // 移回原点
			// ctx.translate(-textWidth / 2, -textHeight / 2); 
			// ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; // 半透明黑色
			// // 绘制文本，注意要将原点移动回左上角
			// ctx.fillText(text, 0, textHeight);

			// 将 Canvas 转换为图像
			const dataURL = canvas.toDataURL('image/png');

			return dataURL;
		},

		async checkPhotoSearchAuth(userToken) {
			try {
				uni.showLoading();
				const result = await api.canSearchPhoto({
					user_token: userToken,
				});
				const data = result?.data?.data || {};
				const canUsePhotoSearch = data?.is_whitelist === true;
				this.has_auth = canUsePhotoSearch;
				// 没有权限，跳转到首页
				// if (!canUsePhotoSearch) {
				// 	uni.navigateTo({
				// 		url: '/platforms/h5/index/index',
				// 	});
				// }
			} catch (err) {
				// ignore
				this.has_auth = false;
			} finally {
				uni.hideLoading();
			}
		},

		handleClear() {
			this.page = 1;
			this.pagesize = 10;
			this.tips_msg = '请输入查询条件，点击搜索查询';
			this.search_result = [];
		},

		handleSearch(filters) {
			this.filters = filters;
			this.fetchDataList(filters, { page: this.page || 1, pagesize: this.pagesize || 10 });
		},

		async fetchDataList(filters, pager) {
			try {
				if (!filters || Object.keys(filters).length === 0) {
					this.tips_msg = '查询条件不能为空'
					return;
				}

				const isEmpty = Object.keys(filters).every(key => !filters[key]);
				if (isEmpty) {
					this.tips_msg = '查询条件不能为空'
					return;
				}

				this.tips_msg = '';

				uni.showLoading();

				const postData = { ...pager };

				if (filters.username) {
					postData.transferor = filters.username;
					postData.payee = filters.username;
				}
				if (filters.amount_min) {
					const num = Number(filters.amount_min);
					if (!isNaN(num)) {
						postData.amount_min = num;
					} else {
						this.tips_msg = '金额请输入数字';
						return;
					}
				}
				if (filters.amount_max) {
					const num = Number(filters.amount_max);
					if (!isNaN(num)) {
						postData.amount_max = num;
					} else {
						this.tips_msg = '金额请输入数字';
						return;
					}
				}
				if (filters.date_min) {
					postData.start_time = filters.date_min;
				}
				if (filters.date_max) {
					postData.end_time = filters.date_max;
				}

				if (filters.upload_date_min) {
					postData.start_upload_time = filters.upload_date_min;
				}
				if (filters.upload_date_max) {
					postData.end_upload_time = filters.upload_date_max;
				}

				if (filters.keyword) {
					// 多个内容以逗号或分号分隔，同时支持中英文符号
					const content = String(filters.keyword).split(/[,，;；]/).filter(Boolean);
					postData.content = (content).join(';');
				}

				if (Object.keys(postData).length <= 0) {
					this.tips_msg = '查询条件不能为空';
					return;
				}


				const userToken = uni.getStorageSync('user_token');

				const result = await api.searchPhoto({
					...postData,
					user_token: userToken,
				});

				console.log('result: ', result);

				// 响应码为'0000'表示正确
				if (result?.data?.code !== '0000') {
					alert(result?.data?.msg || '查询错误');
					return;
				}

				const list = (result?.data?.data?.records || []).map(item => {
					return {
						...item,
						imageUrl: `${item.url}&user_token=${userToken}`
					}
				});
				const totalCount = result?.data?.data?.total || 0;

				this.search_result = list;
				this.pagecount = totalCount;

				setTimeout(() => {
					// 添加水印
					this.createWatermark(this.userInfo);
				}, 300);
			} catch (err) {
				console.error('查询出错--', err);
				alert(`查询出错: ${err?.statusCode}. ${err?.data}`);
			} finally {
				uni.hideLoading();
			}
		},
	}
}
</script>

<style lang="scss" scoped>
.photo-search-risk-tips {
	background-color: #ff7800;
	text-align: left;
	padding: 10px;
	margin-bottom: 16px;
	border-radius: 8px;
	font-size: 14px;
}

.photo-search-tips {
	height: 200px;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 16px;
}

.pager-container {
	display: flex;
	align-items: center;
	justify-content: center;

	.el-pagination {
		display: flex;
	}

	.block {
		margin-top: 40upx;
		margin-bottom: 40upx;
	}
}
</style>
```

然后在 `HBuilder IDE` 中重新打包，上传到服务器部署即可。

